---
import Layout from '../layouts/Layout.astro';
import { chorusAPI } from '../lib/sdk.js';
---

<Layout>
  <div id="project-container">
    <h1>Loading project...</h1>
  </div>
</Layout>

<script>
    import { chorusAPI } from "../lib/sdk.js";
    import { navigate } from "astro:transitions/client";

    document.addEventListener("astro:page-load", () => {
        chorusAPI
            .isLoggedIn()
            .then((isLoggedIn) => {
                if (!isLoggedIn) {
                    setTimeout(() => {
                        // Redirect to login page after 1 second
                        navigate("/login");
                    }, 1000);
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    const projectId = urlParams.get("project_id");

                    if (projectId) {
                        chorusAPI
                            .getProjectDetails(projectId)
                            .then(async (project) => { // Make the handler async
                                const container = document.getElementById("project-container");
                                container.innerHTML = `
                                    <h1>${project.name}</h1>
                                    <p>${project.description || "No description available."}</p>
                                    <h2>Members</h2>
                                    <ul id="member-list">Loading members...</ul>
                                `;

                                // Fetch usernames for each member ID
                                try {
                                    const memberPromises = project.members.map(memberId =>
                                        chorusAPI.getUserDetailsById(memberId)
                                    );
                                    const memberDetails = await Promise.all(memberPromises);
                                    const memberList = document.getElementById("member-list");
                                    memberList.innerHTML = memberDetails.map(user =>
                                        `<li>${user.username}</li>`
                                    ).join("");
                                } catch (userError) {
                                    console.error("Error loading member details:", userError);
                                    const memberList = document.getElementById("member-list");
                                    memberList.innerHTML = "<li>Error loading some member details.</li>";
                                }
                            })
                            .catch((error) => {
                                console.error("Error loading project details:", error);
                                const container = document.getElementById("project-container");
                                container.innerHTML = "<p>Failed to load project details.</p>";
                            });
                    } else {
                        console.error("No project_id found in URL.");
                        const container = document.getElementById("project-container");
                        container.innerHTML = "<p>Invalid project ID.</p>";
                    }
                }
            })
            .catch((error) => {
                console.error("Error checking login status:", error);
            });
    });
</script>